services:
  backend:
    container_name: kalianak_backend_dev
    build: ./backend
    env_file:
      - .env
    environment:
      # Override DB_HOST/PORT from .env — dev connects via SSH tunnel on host machine.
      # Run tunnel BEFORE docker compose up (keep this terminal open):
      #   ssh -L 5433:localhost:5434 -L 9000:localhost:9000 anders@109.205.177.108
      # 5433 (local) → 5434 (server localhost) → prod DB container:5432
      # Port 5434 on the server avoids conflict with the other project occupying 5432.
      # Requires deploy.sh to have been run so prod DB exposes its port on server localhost.
      DB_HOST: host.docker.internal
      DB_PORT: "5433"
    volumes:
      - ./backend:/app
    ports:
      - "8001:8000"
    # Allows backend to reach host machine (needed for SSH-tunnelled live DB/MinIO)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); r=s.connect_ex((\"localhost\",8000)); s.close(); exit(r)'"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s
    restart: unless-stopped

  frontend:
    container_name: kalianak_frontend_dev
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_modules:/app/node_modules
    ports:
      - "3001:3000"
    command: sh -c "npm install && npm run dev -- --host"
    env_file:
      - .env
    depends_on:
      backend:
        condition: service_healthy

  web_frontend:
    container_name: kalianak_web_frontend_dev
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./web_frontend:/app
      - web_frontend_modules:/app/node_modules
    ports:
      - "3002:3000"
    command: sh -c "npm install && npm run dev -- --host"
    env_file:
      - .env
    depends_on:
      backend:
        condition: service_healthy

  member_app:
    container_name: kalianak_member_app_dev
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./member_app:/app
      - member_app_modules:/app/node_modules
    ports:
      - "3003:5173"
    command: sh -c "npm install && npm run dev -- --host"
    env_file:
      - .env
    depends_on:
      backend:
        condition: service_healthy

volumes:
  frontend_modules:
  web_frontend_modules:
  member_app_modules:
